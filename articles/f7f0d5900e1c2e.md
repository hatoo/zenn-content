---
title: "mitmproxy„Åø„Åü„ÅÑ„Å™„ÇÑ„Å§„ÇíRust„Åß‰Ωú„Å£„Åü„ÅÆ„ÅßÂ≠¶„Çì„Å†„Åì„Å®Êõ∏„Åè"
emoji: "ü¶Ä"
type: "tech" # tech: ÊäÄË°ìË®ò‰∫ã / idea: „Ç¢„Ç§„Éá„Ç¢
topics: ["rust", "http", "hyper"]
published: false
---

# „ÅØ„Åò„ÇÅ„Å´

Rust„Åß[mitmproxy](https://mitmproxy.org/)„Åø„Åü„ÅÑ„Å™„ÇÑ„Å§„Çí‰Ωú„Çå„Çã„É©„Ç§„Éñ„É©„É™„ÇíÂÖ¨Èñã„Åó„Åü„ÅÆ„Åß„Åù„ÅÆ„Å®„Åç„Å´Â≠¶„Çì„Å†„Åì„Å®„ÇíÊõ∏„Åç„Åæ„Åô„ÄÇ„É™„Éù„Ç∏„Éà„É™„ÅØ„Åì„Å°„Çâ„ÄÇ
https://github.com/hatoo/http-mitm-proxy

## mitmproxy„Å®„ÅØ

[mitmproxy](https://mitmproxy.org/)„ÅØ„ÄÅHTTP„ÅÆ„Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éê„Éº„Åß„ÄÅHTTPS„ÅÆÈÄö‰ø°„ÅÆÂÜÖÂÆπ„ÇÇË¶ã„Çã„Åì„Å®„Åå„Åß„Åç„Çã„ÅÆ„ÅåÁâπÂæ¥„Åß„Åô„ÄÇ

## HTTP„Éó„É≠„Ç≠„Ç∑

HTTP„Éó„É≠„Ç≠„Ç∑„ÅØHTTP„ÅÆ„É¨„Éô„É´„ÅßÂãï‰Ωú„Åô„Çã„Éó„É≠„Ç≠„Ç∑„Åß„Åô„ÄÇ„Å™„ÅÆ„Åß„Éó„É≠„Ç≠„Ç∑ÂÅ¥„ÇÇHTTP„ÇíÁêÜËß£„Å£„Å¶„Å™„Åë„Çå„Å∞„Å™„Çä„Åæ„Åõ„Çì„ÄÇ

### HTTP„ÅÆÈÄö‰ø°(„Éó„É≠„Ç≠„Ç∑„Å™„Åó)

```bash
printf "GET / HTTP/1.1\r\nHost: example.com\r\nConnection: close\r\n\r\n" | nc example.com 80
HTTP/1.1 200 OK
Accept-Ranges: bytes
Age: 360610
Cache-Control: max-age=604800
Content-Type: text/html; charset=UTF-8
Date: Mon, 18 Nov 2024 06:44:56 GMT
Etag: "3147526947+gzip"
Expires: Mon, 25 Nov 2024 06:44:56 GMT
Last-Modified: Thu, 17 Oct 2019 07:18:26 GMT
Server: ECAcc (sac/256D)
Vary: Accept-Encoding
X-Cache: HIT
Content-Length: 1256
Connection: close

... # ‰ª•‰∏ãBody (ÁúÅÁï•)
```

### HTTP„ÅÆÈÄö‰ø°(„Éó„É≠„Ç≠„Ç∑„Çí‰Ωø„ÅÜ)

```bash
printf "GET http://example.com/ HTTP/1.1\r\nHost: example.com\r\nConnection: close\r\n\r\n" | nc localhost 3003 # http://localhost:3003 HTTP„Å´„Éó„É≠„Ç≠„Ç∑„ÇíÁ´ã„Å¶„Å¶„ÅÑ„Çã
HTTP/1.1 200 OK
... # Âêå„Åò„Å™„ÅÆ„Åß‰ª•‰∏ãÁúÅÁï•
```

„Åì„ÅÆ„Çà„ÅÜ„Å´„ÅÑ„Å§„ÇÇ„Å™„Çâ`GET / HTTP/1.1`„Å®ÈÄÅ„Çã„Å®„Åì„Çç„Çí`GET http://example.com/ HTTP/1.1`„Å®ÈÄÅ„Çã„Åì„Å®„Åß„Éó„É≠„Ç≠„Ç∑„Å´„Å©„Åì„Å´„Ç¢„ÇØ„Çª„Çπ„Åó„Åü„ÅÑ„Åã„Çí‰ºù„Åà„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ
„Éó„É≠„Ç≠„Ç∑„ÅåÁõ∏Êâã„Å®ÈÄö‰ø°„Åó„Å¶ÁµêÊûú„ÇíËøî„Åó„Å¶„Åè„Çå„Çã„ÅÆ„Åß„ÄÅ„Éó„É≠„Ç≠„Ç∑ÂÅ¥„ÅßÂÜÖÂÆπ„ÇíË¶ã„Åü„ÇäÁ∑®ÈõÜ„Åó„Åü„Çä„Åô„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ

### HTTPS„ÅÆÈÄö‰ø°(„Éó„É≠„Ç≠„Ç∑„Å™„Åó)

```bash
printf "GET / HTTP/1.1\r\nHost: example.com\r\nConnection: close\r\n\r\n" | ncat --ssl example.com 443
... # Âêå„Åò„Å™„ÅÆ„Åß‰ª•‰∏ãÁúÅÁï•
```

### HTTPS„ÅÆÈÄö‰ø°(„Éó„É≠„Ç≠„Ç∑„Çí‰Ωø„ÅÜ)

„Åì„Çå„ÅØÁâπÊÆä„Å™„ÅÆ„Åßcurl„Åß„ÇÑ„Å£„Å¶„Åø„Åæ„Åô„ÄÇ

```bash
curl -v https://example.com -x http://localhost:3003
*   Trying 127.0.0.1:3003...
* Connected to (nil) (127.0.0.1) port 3003 (#0)
* allocate connect buffer!
* Establish HTTP proxy tunnel to example.com:443
> CONNECT example.com:443 HTTP/1.1
> Host: example.com:443
> User-Agent: curl/7.81.0
> Proxy-Connection: Keep-Alive
>
< HTTP/1.1 200 OK
< Date: Mon, 18 Nov 2024 10:17:21 GMT
<
* Proxy replied 200 to CONNECT request
* CONNECT phase completed!
* ALPN, offering h2
* ALPN, offering http/1.1
*  CAfile: /etc/ssl/certs/ca-certificates.crt
*  CApath: /etc/ssl/certs
* TLSv1.0 (OUT), TLS header, Certificate Status (22):
* TLSv1.3 (OUT), TLS handshake, Client hello (1):
* TLSv1.2 (IN), TLS header, Certificate Status (22):
* TLSv1.3 (IN), TLS handshake, Server hello (2):
* TLSv1.2 (OUT), TLS header, Finished (20):
* TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):
* TLSv1.2 (OUT), TLS header, Certificate Status (22):
* TLSv1.3 (OUT), TLS handshake, Client hello (1):
* TLSv1.2 (IN), TLS header, Finished (20):
* TLSv1.2 (IN), TLS header, Certificate Status (22):
* TLSv1.3 (IN), TLS handshake, Server hello (2):
* TLSv1.2 (IN), TLS header, Supplemental data (23):
* TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):
* TLSv1.2 (IN), TLS header, Supplemental data (23):
* TLSv1.3 (IN), TLS handshake, Certificate (11):
* TLSv1.2 (IN), TLS header, Supplemental data (23):
* TLSv1.3 (IN), TLS handshake, CERT verify (15):
* TLSv1.2 (IN), TLS header, Supplemental data (23):
* TLSv1.3 (IN), TLS handshake, Finished (20):
* TLSv1.2 (OUT), TLS header, Supplemental data (23):
* TLSv1.3 (OUT), TLS handshake, Finished (20):
* SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384
* ALPN, server accepted to use h2
* Server certificate:
*  subject: C=US; ST=California; L=Los Angeles; O=InternetÔøΩCorporationÔøΩforÔøΩAssignedÔøΩNamesÔøΩandÔøΩNumbers; CN=www.example.org
*  start date: Jan 30 00:00:00 2024 GMT
*  expire date: Mar  1 23:59:59 2025 GMT
*  subjectAltName: host "example.com" matched cert's "example.com"
*  issuer: C=US; O=DigiCert Inc; CN=DigiCert Global G2 TLS RSA SHA256 2020 CA1
*  SSL certificate verify ok.
* Using HTTP2, server supports multiplexing
* Connection state changed (HTTP/2 confirmed)
* Copying HTTP/2 data in stream buffer to connection buffer after upgrade: len=0
* TLSv1.2 (OUT), TLS header, Supplemental data (23):
* TLSv1.2 (OUT), TLS header, Supplemental data (23):
* TLSv1.2 (OUT), TLS header, Supplemental data (23):
* Using Stream ID: 1 (easy handle 0x559036dbdeb0)
* TLSv1.2 (OUT), TLS header, Supplemental data (23):
> GET / HTTP/2
> Host: example.com
> user-agent: curl/7.81.0
> accept: */*
>
* TLSv1.2 (IN), TLS header, Supplemental data (23):
* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
* TLSv1.2 (IN), TLS header, Supplemental data (23):
* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
* old SSL session ID is stale, removing
* TLSv1.2 (IN), TLS header, Supplemental data (23):
* TLSv1.2 (OUT), TLS header, Supplemental data (23):
* TLSv1.2 (IN), TLS header, Supplemental data (23):
* TLSv1.2 (IN), TLS header, Supplemental data (23):
* TLSv1.2 (IN), TLS header, Supplemental data (23):
< HTTP/2 200
< age: 533083
< cache-control: max-age=604800
< content-type: text/html; charset=UTF-8
< date: Mon, 18 Nov 2024 10:17:23 GMT
< etag: "3147526947+gzip+ident"
< expires: Mon, 25 Nov 2024 10:17:23 GMT
< last-modified: Thu, 17 Oct 2019 07:18:26 GMT
< server: ECAcc (sac/251E)
< vary: Accept-Encoding
< x-cache: HIT
< content-length: 1256
<
* TLSv1.2 (IN), TLS header, Supplemental data (23):
* TLSv1.2 (IN), TLS header, Supplemental data (23):
... # ‰ª•‰∏ãBodyÁúÅÁï•
* Connection #0 to host (nil) left intact
```

ÊúÄÂàù„Å´„Éó„É≠„Ç≠„Ç∑„Å´`CONNECT example.com:443 HTTP/1.1`„Å®ÈÄÅ„Çã„Åì„Å®„Åß„Éó„É≠„Ç≠„Ç∑„Å´ÂØæ„Åó„Å¶HTTPS„ÅÆÈÄö‰ø°„Çí„Åô„Çã„Åì„Å®„Çí‰ºù„Åà„Åæ„Åô„ÄÇ
„Åù„ÅÆÂæå„ÅØexample.com:443„Å®TCP„ÅÆ„É¨„Éô„É´„Åß„Éà„É≥„Éç„É™„É≥„Ç∞„Åï„Çå„Çã„ÅÆ„Åß„Åù„Åì„Åã„ÇâÊôÆÈÄö„Å´HTTPS„ÅÆÈÄö‰ø°„ÇíË°å„ÅÑ„Åæ„Åô„ÄÇ(„Åì„ÅÆ‰æã„Åß„ÅØexmaple.com„Å®HTTP/2„ÅßÈÄö‰ø°„Åó„Å¶„ÅÑ„Åæ„Åô)
„Éà„É≥„Éç„É™„É≥„Ç∞„Åï„Çå„Åü„ÅÇ„Å®„ÅÆÈÄö‰ø°„ÅØÊöóÂè∑Âåñ„Åï„Çå„Å¶„ÅÑ„Çã„ÅÆ„Åß„Éó„É≠„Ç≠„Ç∑ÂÅ¥„ÅßÂÜÖÂÆπ„ÇíË¶ã„Çã„Åì„Å®„ÅØ„Åß„Åç„Åö„ÄÅÁ∑®ÈõÜ„Åó„Å¶„ÇÇ„Éê„É¨„Åæ„Åô„ÄÇ

## mitmproxy„ÅÆ‰ªïÁµÑ„Åø

‰∏äË®ò„ÅÆ„Çà„ÅÜ„Å´ÈÄöÂ∏∏„ÅÆ„Éó„É≠„Ç≠„Ç∑„ÅØHTTPS„ÅÆÈÄö‰ø°„ÇíË¶ã„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åõ„Çì„Åå„ÄÅmitmproxy„ÅØ„ÅÇ„Çâ„Åã„Åò„ÇÅ„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Å´ÂØæ„Åó„Å¶Ëá™ÂàÜ„ÅÆË®ºÊòéÊõ∏„Çí„É´„Éº„ÉàË®ºÊòéÊõ∏„Å®„Åó„Å¶‰ø°Áî®„Åó„Å¶„ÇÇ„Çâ„ÅÜ„Åì„Å®„Åß„ÄÅ„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Å®‰∏≠Á∂ôÂÖà„Å®„ÅÆÈÄö‰ø°„ÇíË¶ã„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ
ÂêÑ‰∏≠Á∂ôÂÖà„ÅÆË®ºÊòéÊõ∏„ÅØ„Åù„ÅÆÂ†¥„Åßmitmproxy„Åå‰ΩúÊàê„Åó„ÅüË®ºÊòéÊõ∏„ÅßÁΩ≤Âêç„Åï„Çå„Åü„ÇÇ„ÅÆ„Å´ÁΩÆ„ÅçÊèõ„Åà„Çâ„Çå„Åæ„Åô„ÄÇ

```mermaid
sequenceDiagram
    participant „ÇØ„É©„Ç§„Ç¢„É≥„Éà
    participant mitmproxy
    „ÇØ„É©„Ç§„Ç¢„É≥„Éà->>mitmproxy: CONNECT example.com:443 HTTP/1.1
    mitmproxy->>„ÇØ„É©„Ç§„Ç¢„É≥„Éà: HTTP/1.1 200 OK
    „ÇØ„É©„Ç§„Ç¢„É≥„Éà->>mitmproxy: TLS„Åó„Çà
    mitmproxy->>„ÇØ„É©„Ç§„Ç¢„É≥„Éà: „Åì„Çå„Åå„ÅÇ„Å™„Åü„Åå‰ø°„Åò„Çã‰ø∫„ÅåÁΩ≤Âêç„Åó„Åü`example.com`„ÅÆË®ºÊòéÊõ∏„Å†„Çà
    „ÇØ„É©„Ç§„Ç¢„É≥„Éà->>mitmproxy: „Åà„Åà„ÇÑ„Çì! GET / HTTP/1.1\r\nHost: example.com\r\n\r\n
```
