---
title: "è„†å¼±æ€§ã‚’æ¢ã—ã«è¡Œã£ã¦è¦‹ã¤ã‘ãŸè©±"
emoji: "â›"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["rust", "security"]
published: false
---

# ã¯ã˜ã‚ã«

[no starch press](https://nostarch.com/)ã‹ã‚‰[From Day Zero to Zero Day](https://nostarch.com/zero-day)^[æ­£å¼ãªç™ºå£²æ—¥ã¯2025/8/12ã®ã‚ˆã†ã§ã™ãŒã€O'Reilly Safari Books Onlineã§ã¯ã™ã§ã«èª­ã‚ã¾ã™ã€‚ãŠã™ã™ã‚]ã¨ã„ã†æœ¬ãŒå‡ºãŸã®ã§èª­ã‚“ã§ã„ã¾ã—ãŸã€‚
ç¬¬3ç« ã¾ã§èª­ã‚“ã ã®ã§ä¸€æ—¦å®Ÿè·µã—ã¦ã¿ã‚ˆã†ã¨æ€ã„è‡ªåˆ†ã§æœªçŸ¥ã®è„†å¼±æ€§ã‚’æ¢ã—ã¦ã„ãŸã¨ã“ã‚ã€é‹è‰¯ã[ä¸€å€‹](https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-fm79-3f68-h2fc)è¦‹ã¤ã‘ãŸã®ã§ãã“ã«è‡³ã‚‹ã¾ã§ã®éç¨‹ã‚’æ›¸ã„ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

# ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ¢ã™

æœ¬ã«ã¯

- Familiarity
- Availability
- Implact

ã‚’æ„è­˜ã—ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ¢ã™ã¨ã‚ˆã„ã¨ã„ã†ã‚ˆã†ãªã“ã¨ãŒæ›¸ã„ã¦ã‚ã£ãŸã®ã§ã€ã¾ãšè‡ªåˆ†ã®å¾—æ„ãª`Rust`ã§ä½œã‚‰ã‚Œã¦ã„ã‚‹OSSã‹ã‚‰è„†å¼±æ€§ã‚’æ¢ã™ã“ã¨ã«ã—ã¾ã—ãŸã€‚

## æ—¢çŸ¥ã®è„†å¼±æ€§ã‚’æ¢ã™

3ç«  `Variant analysis` ã«æ—¢çŸ¥ã®è„†å¼±æ€§ã‹ã‚‰ç›´ã—å¿˜ã‚Œã‚’æ¢ã™ã¨è‰¯ã„ã¨ã„ã†ã“ã¨ãŒæ›¸ã„ã¦ã‚ã£ãŸã®ã§[RUSTSEC](https://rustsec.org/advisories/)ã¨ã‹[GitHub Advisory Database](https://github.com/advisories?query=ecosystem%3Arust)ã‚’è¦‹ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚
è„†å¼±æ€§ã‚’æ¢ã™ç›®çš„ã§OSSã‚’æ¢ã™ã“ã¨ã¯ä»Šã¾ã§ãªã‹ã£ãŸã®ã§ã™ãŒã€å°‘ãªãã¨ã‚‚ãã“ã‹ã‚‰ãªã«ã‹ã‚¤ãƒ³ã‚¹ãƒ”ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¾—ã‚‰ã‚Œãªã„ã‹ã¨æ€ã„ãªãŒã‚‰è¦‹ã¦ã„ã¾ã—ãŸã€‚

ãã“ã§ãƒ”ãƒ³ã¨ããŸã®ãŒã€[bytecodealliance/wasmtime](https://github.com/bytecodealliance/wasmtime)ã®[Wasmtime doesn't fully sandbox all the Windows device filenames](https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-c2f5-jxjv-2hh8)ã§ã—ãŸã€‚

ã“ã®è„†å¼±æ€§ã®è©³ã—ã„å†…å®¹ã¯å‰²ã¨ã©ã†ã§ã‚‚ã„ã„ã®ã§ã™ãŒã€Webassembly(WASI)ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã¨ã„ã†éƒ¨åˆ†ã«ä½•ã‹ç›´æ„Ÿã‚’æ„Ÿã˜ã¾ã—ãŸã€‚
è‡ªåˆ†ã§å®Ÿè£…ã™ã‚‹ã“ã¨ã‚’æƒ³åƒã—ãŸã‚‰ã¡ã‚‡ã£ã¨å«Œã ã—ã€çµ¶å¯¾ä»–ã«ä½•ã‹ãƒã‚°ãŒã‚ã‚‹ã ã‚ã†ã¨æ€ã„ã¾ã—ãŸã€‚

æœ¬ã«è¼‰ã£ã¦ãŸã‚ˆã†ãªã€CodeQLã¨ã‹Semgrepãªã©ã®é™çš„è§£æã‚’ä½¿ã£ãŸ`Variant analysis`ã¯å‡ºæ¥ãªã•ãã†ã§ã™ãŒã¨ã‚Šã‚ãˆãšã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

# ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼

`Wasmtime`ã®`WASI`ã®å®Ÿè£…ã¯

- [Preview0](https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi/src/preview0.rs)
- [Preview1](https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi/src/preview1.rs)
- [Preview2](https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi/src/p2/filesystem.rs)

ã¨ã„ãã¤ã‹ã‚ã‚Šã¾ã™ãŒã€é‹è‰¯ãæœ€åˆã«é–‹ã„ãŸ`Preview1`ã®å®Ÿè£…ã§ãªã«ã‚„ã‚‰æ€ªã—ã„éƒ¨åˆ†ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚

ã“ã“ã§ã™
https://github.com/bytecodealliance/wasmtime/blob/804060c8ea7a1f938f896c3af3a65ed44b115778/crates/wasi/src/preview1.rs#L286-L304

ã“ã®`impl DerefMut for Descriptors`ã«**éå¸¸ã«å¼·ã„é•å’Œæ„Ÿ**ã‚’è¦šãˆã¾ã—ãŸã€‚
`Descriptors`ã¯Linuxã®file descriptorã¨åŒã˜ã§ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‹ã‚’é–‹ã„ãŸã¨ãã¨ã‹ã«å‰²ã‚ŠæŒ¯ã‚‰ã‚Œã‚‹ã‚„ã¤ã§ã™ã€‚
å•é¡Œã¯ã“ã®`Descriptors`ã¯å¸¸è­˜çš„ã«è€ƒãˆã¦ã€

$$ \mathit{keys}(\mathit{used}) \cap \mathit{free} = \varnothing $$

ã®é–¢ä¿‚ã‚’ç¶­æŒã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒ(`used`ã¨`free`ãŒåŒã˜æ•°å­—ã®descriptorã‚’æŒã£ã¦ã„ãŸã‚‰ãªã«ã‹å¤‰ãªã“ã¨ãŒèµ·ãã‚‹ã¨ã„ã†ã“ã¨ãŒè¨€ã„ãŸã„)
`impl DerefMut for Descriptors`ãŒã‚ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€åˆ¥ã®å ´æ‰€ã§`used`ã®ã¿ã‚’è§¦ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ â†’ é–“é•ã£ã¦ä¸Šè¨˜ã®é–¢ä¿‚ãŒã¶ã£å£Šã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ã¨ã„ã†ã‚ã‘ã§`Descriptors`ã®`DerefMut`ã‚’ä½¿ã£ã¦ã„ã‚‹ã¨ã“ã‚ã‚’æ¢ã—ãŸã¨ã“ã‚è¦‹ã¤ã‹ã£ãŸã®ãŒã“ã‚Œã§ã™ã€‚

https://github.com/bytecodealliance/wasmtime/blob/804060c8ea7a1f938f896c3af3a65ed44b115778/crates/wasi/src/preview1.rs#L1825-L1836

`fd_renumber`ã¯WASI preview1ã®`dip2(2)`ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚

```rust
st.descriptors.insert(to.into(), desc);
```

ã“ã®éƒ¨åˆ†ãŒ`free`ã‚’ã‚±ã‚¢ã—ã¦ã„ãªãã¦ã€æ˜ã‚‰ã‹ã«ãƒ¤ãƒãã†ã§ã™ã€‚

ã¨ã„ã†ã‚ã‘ã§POC

```rust
// wasi = "=0.11.1"
use std::os::fd::{AsFd, AsRawFd};

fn main() {
    let file0 = std::fs::File::create("test0").unwrap();
    let fd0 = file0.as_fd().as_raw_fd();

    unsafe { wasi::fd_renumber(fd0 as u32, fd0 as u32) }.unwrap();

    let file1 = std::fs::File::create("test1").unwrap(); // This line cause a panic in assertion
    let fd1 = file1.as_fd().as_raw_fd();

    dbg!(fd0, fd1);
}
```

ã“ã‚ŒãŒå®Ÿè¡Œæ™‚ã«ãªã‚“ã‚„ã‹ã‚“ã‚„ã§
https://github.com/bytecodealliance/wasmtime/blob/968952abe5f317313032a5442a301b3fdd198d56/crates/wasi/src/preview1.rs#L415
ã§panicã—ã¾ã™ã€‚

# panicã¯è„†å¼±æ€§ãªã®ã‹

çµè«–ã‹ã‚‰è¨€ãˆã°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚ˆã‚Šã¾ã™ã€‚

`wasmtime`ã®[ä»–ã®è„†å¼±æ€§](https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-75hq-h6g9-h4q5)ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€panicã¯DOSæ‰±ã„ã«ãªã‚‹ã‚ˆã†ã§ã™ã€‚
ã—ã‹ã—ã€ä»–ã®Rustãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®[cloudflare/pingora](https://github.com/cloudflare/pingora/blob/main/docs/user_guide/panic.md)ã‚’è¦‹ã¦ã¿ã‚‹ã¨ãŸã ã®panicãã‚‰ã„ãªã‚‰(å˜ä¸€ã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãŒãŠã‹ã—ããªã‚‹ã ã‘ãªã®ã§)è„†å¼±æ€§ã¨ã¾ã§ã¯ã„ã‹ãªã„æ„Ÿã˜ãŒã—ã¾ã™ã€‚

# ãƒ¬ãƒãƒ¼ãƒˆã‚’é€ã‚‹

`wasmtime`ã§ã¯ã“ã®ãƒã‚°ã¯è„†å¼±æ€§ãªæ°—ãŒã—ãŸãŸã‚GitHubã®Securityã‚¿ãƒ–ã‹ã‚‰[ãƒ¬ãƒãƒ¼ãƒˆ](https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-fm79-3f68-h2fc)ã‚’é€ã‚Šã¾ã—ãŸã€‚

# çµæœ

ã™ãã«è¿”ä¿¡ãŒã‚ã‚Šã€ç´„ä¸€é€±é–“ã§ãƒ‘ãƒƒãƒãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œå…¬é–‹ã¨ãªã‚Šã¾ã—ãŸã€‚
[CVE-2025-53901](https://nvd.nist.gov/vuln/detail/CVE-2025-53901)ã¨ã—ã¦CVEã®ç•ªå·ã‚‚ã¤ãã¾ã—ãŸã€‚ğŸ¥³

[ãƒšãƒ¼ã‚¸](https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-fm79-3f68-h2fc)ã«ã¯ã—ã£ã‹ã‚Šã¨è„†å¼±æ€§ã®è©³ç´°ãŒæ›¸ã‹ã‚Œã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯å¾Œã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ–¹ãŒä½œã£ã¦ãã‚ŒãŸæ–‡ç« ã§ã™ã€‚
ãªã®ã§ãƒ¬ãƒãƒ¼ãƒˆã™ã‚‹æ™‚ç‚¹ã§ã“ã“ã¾ã§ã—ã£ã‹ã‚Šæ›¸ãå¿…è¦ã¯ãªãé–‹ç™ºè€…ã®æ–¹ã«æ„å›³ãŒä¼ã‚ã‚Œã°ååˆ†ãªæ°—ãŒã—ã¾ã™ã€‚

# çµè«–

- æ„å¤–ã«æ¢ã›ã°è„†å¼±æ€§ã‚ã‚‹
- ã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’è¦‹ãªãã¦ã‚‚å±€æ‰€çš„ãªæƒ…å ±ã‹ã‚‰ãªã«ã‹è¦‹ã¤ã‘ã‚‰ã‚Œã‚‹
- é‹ãŒè‰¯ã‹ã£ãŸ
