---
title: "Rustのパーサーライブラリ、Chumskyの紹介"
emoji: "🦀"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Rust"]
published: false
---

# はじめに

この記事ではRustのパーサーライブラリ、[Chumsky](https://github.com/zesterer/chumsky)を使って[Learn LLVM 12](https://www.packtpub.com/product/learn-llvm-12/9781839213502)に載っている`calc`言語をパースしていきます。
もちろんこの記事を読むにあたってLearn LLVM 12を読む必要はありませんがLLVMを使ったコード生成に興味がある方は読むことをおすすめします。

## 参考リンク

* [Chumsky](https://github.com/zesterer/chumsky)
    本書で紹介するChumskyのリポジトリ
* [Ariadne](https://github.com/zesterer/ariadne)
    エラー表示用のライブラリ。Chumskyと同じ作者が作っている
* [Tao](https://github.com/zesterer/tao)
    Chumskyと同じ作者が作っているプログラミング言語。パーサーにChumskyを使っているので例を見るのにちょうど良い

# Chumskyとは

[Chumsky](https://github.com/zesterer/chumsky)はRust用のパーサーライブラリで、他のパーサーライブラリと比べると

* エラー処理に力を入れている
* [Ariadne](https://github.com/zesterer/ariadne)と連携することでかっこいいエラー表示ができる
* トークン列用のパーサーから元の文字列の範囲(スパン)を取れる

などの特徴があり、個人的には自作プログラミング言語用のパーサーを作るのにかなり適していると感じています。

## パフォーマンス

パフォーマンスはChumskyの最優先事項ではないようですが、現在開発中のZero-Copy parsing機能(マッチした文字列を`String`ではなく元の入力への`&str`で取る機能)を使ったベンチマークでは`JSON`のパースが`nom`よりも速いという結果が出ています(これはおどろき)。[#94](https://github.com/zesterer/chumsky/pull/94)

# `calc`の説明

この記事ではLearn LLVM 12ででてくる`calc`をパースしてASTを作っていくので、`calc`の説明をしていきたいと思います。

`calc`の文法はこんな感じです。だいたいわかると思います。

```
calc : ("with" ident ("," ident)* ":")? expr
expr : term (("+" | "-") term)*
term : factor (("*" | "/") factor)*
factor : ident | number | "(" expr ")"
ident : ([a-zA-Z])+
number : ([0-9])+
```

やっていることは変数を宣言して(もしくはしないで)四則演算を行うだけです

例:

```
# exprのみ。3が返ってくる
1 + 2
# 入力としてa, bをとってa+bを計算する
with a, b : a + b
```

# Lexerをつくる

さっそくLexerを作っていきます

