---
title: "Xorshiftã‚’çµ±è¨ˆãƒ†ã‚¹ãƒˆã§è½ã¨ãã†ï¼"
emoji: "ğŸ¥‡"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ä¹±æ•°", "rust"]
published: false
---

# ã¯ã˜ã‚ã«

https://en.wikipedia.org/wiki/Xorshift

> For execution in software, xorshift generators are among the fastest PRNGs, requiring very small code and state. However, they do not pass every statistical test without further refinement. This weakness is amended by combining them with a non-linear function, as described in the original paper. Because plain xorshift generators (without a non-linear step) fail some statistical tests, they have been accused of being unreliable.[3]:â€Š360â€Š

ç´ ã®Xorshift^[xoshiroãªã©ã®æ´¾ç”Ÿã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¯ä»Šå›è€ƒãˆã¾ã›ã‚“]ã¯éç·šåŒ–ã‚’æŒŸã¾ãªã„ã¨çµ±è¨ˆãƒ†ã‚¹ãƒˆã«è½ã¡ã‚‹ã¨ã‚ˆãè¨€ã‚ã‚Œã¾ã™ã€‚
ä»Šå›ã¯å®Ÿéš›ã«çŠ¶æ…‹æ•°32bitã®Xorshiftã‚’MatrixRank^[TestU01ã§ã„ã†`smarsa_MatrixRank`]ã§è½ã¨ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼^[çŠ¶æ…‹æ•°ãŒ32bitã¨å°‘ãªã‚ãªã®ã§ä»–ã«ã‚‚å¤šãã®è½ã¨ã—æ–¹ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ãŒä»Šå›ã¯xorshiftç‰¹æœ‰ã£ã½ã„ã‚„ã‚Šæ–¹ã§ã„ãã¾ã™]

# Xorshiftã®å¾©ç¿’

Cè¨€èªã®Xorshiftã®å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¾ã™ã€‚

```c
#include <stdint.h>

struct xorshift32_state {
  uint32_t a;
};

/* The state word must be initialized to non-zero */
uint32_t xorshift32(struct xorshift32_state *state)
{
	/* Algorithm "xor" from p. 4 of Marsaglia, "Xorshift RNGs" */
	uint32_t x = state->a;
	x ^= x << 13;
	x ^= x >> 17;
	x ^= x << 5;
	return state->a = x;
}
```

ã”å­˜çŸ¥ã®é€šã‚Šã€ã“ã®Xorshiftç‰¹æœ‰ã®
```c
x ^= x << 13 /* ãªã«ã‹å®šæ•° */;
```
ã¯ãƒ“ãƒƒãƒˆãƒ™ã‚¯ãƒˆãƒ«ä¸Šã®è¡Œåˆ—ç©ã¨ã—ã¦è¡¨ã›ã¾ã™ã€‚

$$
\exists A : Ax = x \wedge{} (x << c) 
$$

ã¨ã„ã†ã“ã¨ã§

```c
	x ^= x << 13;
	x ^= x >> 17;
	x ^= x << 5;
```

å…¨éƒ¨åˆã‚ã›ã¦ä¸€å€‹ã®è¡Œåˆ—ã¨ãƒ“ãƒƒãƒˆãƒ™ã‚¯ãƒˆãƒ«ã®ç©ã§è¡¨ã›ã¾ã™ã€‚

$$
\exists A : Ax = \mathrm{xorshift32}(x)
$$

# ã˜ã‚ƒã‚ãªã‚“ãªã®ï¼Ÿ

æœ¬æ¥ç†æƒ³çš„ãªä¹±æ•°ã¯ç‹¬ç«‹ã—ã¦ã„ã‚‹ã¹ãã§ã™ãŒXorshiftã®å‡ºåŠ›ã¯**ãƒ“ãƒƒãƒˆãƒ™ã‚¯ãƒˆãƒ«ã¨ã—ã¦ã¿ã‚‹**ã¨ä»–ã®å‡ºåŠ›ã«ã‚ã¡ã‚ƒãã¡ã‚ƒä¾å­˜ã—ã¦ã„ã¾ã™ã€‚

$$
x_{n} = Ax_{n-1}
$$

# Matrix Rank

Matrix Rankã¯PRNGã®å‡ºåŠ›ã‚’ãƒ“ãƒƒãƒˆè¡Œåˆ—ã«ã—ã¦è¡Œåˆ—ã®ãƒ©ãƒ³ã‚¯ã‚’å–ã‚Šã¾ã™ã€‚
ãã®åˆ†å¸ƒã‚’ç†æƒ³çš„ãªåˆ†å¸ƒã¨æ¯”è¼ƒã—ã¦ã‚«ã‚¤äºŒä¹—æ¤œå®š^[ã“ã®è¨˜äº‹ã§ã¯ã—ã¾ã›ã‚“]ã™ã‚Œã°ã ã‚ãªã‚„ã¤ãŒãµã‚‹ã„è½ã¨ã•ã‚Œã‚‹ã¨ã„ã†ã‚ã‘ã§ã™ã€‚

ä»¥ä¸‹32x32ã®ãƒ“ãƒƒãƒˆè¡Œåˆ—ã¨ã—ã¦è©±ã‚’ã—ã¾ã™

## ã­ã‚‰ã„

ä¸€èˆ¬çš„ã«ãƒ™ã‚¯ãƒˆãƒ«ã‚’ç·šå½¢å¤‰æ›ã—ãŸå ´åˆå‰ã¨ä»–ã¨ã®ãƒ™ã‚¯ãƒˆãƒ«ã¯äº’ã„ã«ç‹¬ç«‹ã—ã¦ã„ã‚‹å ´åˆã‚‚ãã†ã§ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
ã§ã™ãŒå°‘ãªãã¨ã‚‚ç†æƒ³çš„ãªä¹±æ•°ã¨åŒã˜ã‚ˆã†ãªãƒ©ãƒ³ã‚¯ã®åˆ†å¸ƒã‚’å†ç¾ã™ã‚‹ã®ã¯é›£ã—ã„ã¯ãšã§ã™ã€‚

## å®Ÿè£…

ãƒ“ãƒƒãƒˆãƒ™ã‚¯ãƒˆãƒ«ã®ãƒ©ãƒ³ã‚¯ã¯æƒãå‡ºã—æ³•ã§ç°¡å˜ã«æ±‚ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```rust
// Rust
// Matrix rank of bit matrix
pub fn matrix_rank(matrix: &mut [u32]) -> usize {
    let n = matrix.len();
    let mut rank = 0;
    for bit in 0..u32::BITS {
        let mut pivot = None;
        for i in rank..n {
            if (matrix[i] >> bit) & 1 == 1 {
                pivot = Some(i);
                break;
            }
        }
        if let Some(pivot) = pivot {
            matrix.swap(rank, pivot);
            for i in 0..n {
                if i != rank && (matrix[i] >> bit) & 1 == 1 {
                    matrix[i] ^= matrix[rank];
                }
            }
            rank += 1;
        }
    }
    rank
}
```

ç†æƒ³çš„ãªä¹±æ•°ã‹ã‚‰ãƒ“ãƒƒãƒˆè¡Œåˆ—ã‚’ä½œã£ãŸã¨ãã®ãƒ©ãƒ³ã‚¯ã®åˆ†å¸ƒã¯ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚‹ã¯ãšã§ã™^[å°å‡ºã¯ã“ã®è¨˜äº‹ã§ã¯ã—ã¾ã›ã‚“]

![plot of expected rank of 32x32 bit matrix](/images/matrixrank_expected.png)

ã¡ãªã¿ã«`/dev/random`ã®ãƒ©ãƒ³ã‚¯ã®åˆ†å¸ƒã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™

10e6å›åˆ†ã®åˆ†å¸ƒã§ã™ï¼ˆä»¥ä¸‹å…¨éƒ¨1e6å›ï¼‰
![plot of rank of 32x32 bit matrix from /dev/random](/images/matrixrank_linuxrandom.png)

# çµæœ

Xorshiftã®ãƒ©ãƒ³ã‚¯ã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™

![plot of rank of 32x32 bit matrix from xorshift](/images/matrixrank_xorshift.png)

ãªã‚“ã¨æœ€é«˜ãƒ©ãƒ³ã‚¯ã—ã‹å‡ºã¾ã›ã‚“ï¼

# ç·©å’Œç­–

ç´ ã®Xorshiftã¯ãƒ“ãƒƒãƒˆã®ä¸–ç•Œã§ç·šå½¢ãªã®ã§MatrixRankã«è½ã¡ã¦ã—ã¾ã„ã¾ã—ãŸã€‚
ãªã®ã§ãƒ“ãƒƒãƒˆã®ä¸–ç•Œã§éç·šå½¢ãªå¤‰æ›ã‚’ã™ã‚Œã°â€¦

```rust
fn xorshift(state: &mut u32) -> u32 {
    *state ^= *state << 13;
    *state ^= *state >> 17;
    *state ^= *state << 5;
    state.wrapping_add(114514)
}
```

![plot of rank of 32x32 bit matrix from xorshift plus const](/images/matrixrank_xorshiftp.png)

ãŠã‰