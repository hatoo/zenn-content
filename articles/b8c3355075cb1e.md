---
title: "Rustã®ãƒ‘ãƒ¼ã‚µãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€Chumskyã®ç´¹ä»‹"
emoji: "ğŸ¦€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Rust"]
published: false
---

# ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã§ã¯Rustã®ãƒ‘ãƒ¼ã‚µãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€[Chumsky](https://github.com/zesterer/chumsky)ã«è»½ãå…¥é–€ã—ã¦ã„ãã¾ã™ã€‚
Chumskyã¯[Ariadne](https://github.com/zesterer/ariadne)ã¨é€£æºã™ã‚‹ã“ã¨ã§ç¶ºéº—ãªã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ã®ã§ãã‚Œã‚‚ã‚„ã£ã¦ã„ãã¾ã™ã€‚

## å‚è€ƒãƒªãƒ³ã‚¯

* [Chumsky](https://github.com/zesterer/chumsky)
    æœ¬æ›¸ã§ç´¹ä»‹ã™ã‚‹Chumskyã®ãƒªãƒã‚¸ãƒˆãƒª
* [Ariadne](https://github.com/zesterer/ariadne)
    ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚Chumskyã¨åŒã˜ä½œè€…ãŒä½œã£ã¦ã„ã‚‹
* [Tao](https://github.com/zesterer/tao)
    Chumskyã¨åŒã˜ä½œè€…ãŒä½œã£ã¦ã„ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã€‚ãƒ‘ãƒ¼ã‚µãƒ¼ã«Chumskyã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ä¾‹ã‚’è¦‹ã‚‹ã®ã«ã¡ã‚‡ã†ã©è‰¯ã„

# Chumskyã¨ã¯

[Chumsky](https://github.com/zesterer/chumsky)ã¯Rustç”¨ã®ãƒ‘ãƒ¼ã‚µãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€ä»–ã®ãƒ‘ãƒ¼ã‚µãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨æ¯”ã¹ã‚‹ã¨

* ã‚¨ãƒ©ãƒ¼å‡¦ç†ã«åŠ›ã‚’å…¥ã‚Œã¦ã„ã‚‹
* [Ariadne](https://github.com/zesterer/ariadne)ã¨é€£æºã™ã‚‹ã“ã¨ã§ã‹ã£ã“ã„ã„ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºãŒã§ãã‚‹ã€‚(ã‚‚ã¡ã‚ã‚“ä»–ã®ãƒ‘ãƒ¼ã‚µãƒ¼ã§ã‚‚Ariadneã‚’ä½¿ã†ã“ã¨ã¯ã§ãã¾ã™)
* ãƒˆãƒ¼ã‚¯ãƒ³åˆ—ç”¨ã®ãƒ‘ãƒ¼ã‚µãƒ¼ã‹ã‚‰å…ƒã®æ–‡å­—åˆ—ã®ç¯„å›²(ã‚¹ãƒ‘ãƒ³)ã‚’å–ã‚Œã‚‹ã€‚å…ˆã«Lexerã§ãƒˆãƒ¼ã‚¯ãƒ³ã«åˆ†å‰²ã—ã¦ãã®ãƒˆãƒ¼ã‚¯ãƒ³åˆ—ã«å¯¾ã—ã¦ã•ã‚‰ã«ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ã¨ã„ã†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¼·åŠ›ã«ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã€‚æœ¬è¨˜äº‹ã§ã¯è§¦ã‚Œã¾ã›ã‚“ãŒå¾Œã§ã“ã‚Œã«é–¢ã™ã‚‹è¨˜äº‹ã‚’æ›¸ãã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ãªã©ã®ç‰¹å¾´ãŒã‚ã‚Šã€å€‹äººçš„ã«ã¯è‡ªä½œãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªç”¨ã®ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ä½œã‚‹ã®ã«ã‹ãªã‚Šé©ã—ã¦ã„ã‚‹ã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¯Chumskyã®æœ€å„ªå…ˆäº‹é …ã§ã¯ãªã„ã‚ˆã†ã§ã™ãŒã€ç¾åœ¨é–‹ç™ºä¸­ã®Zero-Copy parsingæ©Ÿèƒ½(ãƒãƒƒãƒã—ãŸæ–‡å­—åˆ—ã‚’`String`ã§ã¯ãªãå…ƒã®å…¥åŠ›ã¸ã®`&str`ã§å–ã‚‹æ©Ÿèƒ½)ã‚’ä½¿ã£ãŸãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã§ã¯`JSON`ã®ãƒ‘ãƒ¼ã‚¹ãŒ`nom`ã‚ˆã‚Šã‚‚é€Ÿã„ã¨ã„ã†çµæœãŒå‡ºã¦ã„ã¾ã™(ã“ã‚Œã¯ãŠã©ã‚ã)ã€‚[#94](https://github.com/zesterer/chumsky/pull/94)

# Chumskyå…¥é–€

Chumskyã¯ã„ã‚ã‚†ã‚‹ãƒ‘ãƒ¼ã‚µãƒ¼ã‚³ãƒ³ãƒ“ãƒãƒ¼ã‚¿ãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚è‰²ã€…ãªãƒ‘ãƒ¼ã‚µãƒ¼ã‚’çµ„ã¿åˆã‚ã›ã¦ç›®çš„ã®ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚

å…¨ä½“ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯[ã“ã¡ã‚‰](https://github.com/hatoo/zenn-content/tree/master/chumsky-basic)ã«ã‚ã‚Šã¾ã™ã€‚

ä¾‹ã¨ã—ã¦ã€`yyyy/mm/dd`ã®å½¢å¼ã®æ—¥ä»˜ã®ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’æ›¸ã„ã¦ã¿ã¾ã™ã€‚
å„æ•°å­—ã®æ¡æ•°ãŒæƒ³å®šã¨é•ã†å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’å ±å‘Šã—ã¤ã¤ã€ãƒ‘ãƒ¼ã‚¹ã¯ç¶šã‘ã¦ã„ãã‚ˆã†ã«ã—ã¾ã™ã€‚

```rust
use chumsky::prelude::*;

// ãƒ‘ãƒ¼ã‚µãƒ¼ã®å…·ä½“çš„ãªå‹ã¯å¤šãã®å ´åˆæ›¸ãã“ã¨ãŒä¸å¯èƒ½ãªãŸã‚`impl ...`ã‚’ä½¿ã†
// Errorã¨ã—ã¦`chumsky::error::Simple`ã‚’ä½¿ã†ã€‚è‡ªåˆ†ã§ã‚¨ãƒ©ãƒ¼å‹ã‚’å®šç¾©ã—ã¦ç‹¬è‡ªã®ã‚¨ãƒ©ãƒ¼ã‚’ä¿æŒã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã€‚
fn yyyy_mm_dd() -> impl Parser<char, (u32, u32, u32), Error = Simple<char>> {
    // lenæ¡ã®æ•°å­—ã®ãƒ‘ãƒ¼ã‚µãƒ¼
    let number = |len| {
        // 10é€²æ³•ã®æ•°å­—åˆ—
        text::digits(10)
            // å‡ºåŠ›ã‚’ãƒãƒªãƒ‡ãƒ¼ãƒˆã™ã‚‹
            // æ•°å­—åˆ—ã®æ¡æ•°ãŒ`len`ã§ãªã„å ´åˆã‚¨ãƒ©ãƒ¼ã‚’å ±å‘Šã™ã‚‹ãŒã€‚ãƒ‘ãƒ¼ã‚¹å‡¦ç†ã¯ãã®ã¾ã¾ç¶šã
            .validate(move |number: String, span, emit| {
                // [0-9]+ã®æ–‡å­—åˆ—ãªã®ã§ãƒã‚¤ãƒˆé•·ãŒãã®ã¾ã¾æ•°å­—ã®æ¡æ•°ã«ãªã‚‹
                if number.len() != len {
                    // ã‚¨ãƒ©ãƒ¼ã‚’å ±å‘Š
                    // ã©ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå ±å‘Šã§ãã‚‹ã‹ã¯å¾Œè¿°ã™ã‚‹
                    emit(Simple::custom(
                        span,
                        format!("length of a number must be {}, but got {}", len, &number),
                    ))
                }
                number
            })
            // æ•°å­—åˆ—ã‚’u32ã«å¤‰æ›ã™ã‚‹
            // ä¾‹ãˆã°æ•°å­—ãŒå¤§ãã™ãã¦u32ã«å¤‰æ›ã§ããªã„ã¨ãã¯ã‚‚ã†ã©ã†ã—ã‚ˆã†ã‚‚ãªã„ã®ã§ãƒ‘ãƒ¼ã‚¹ã‚’æ‰“ã¡åˆ‡ã‚‹
            .try_map(|number, span| {
                number.parse().map_err(|_| {
                    Simple::custom(span, format!("{} is an invalid u32 string", &number))
                })
            })
    };

    // yyyy
    number(4)
        // ãƒ©ãƒ™ãƒ«ã‚’ä»˜ã‘ã‚‹ã¨ã‚¨ãƒ©ãƒ¼æ™‚ã«ã‚ã‹ã‚Šã‚„ã™ããªã‚‹
        .labelled("yyyy")
        // '/'ã«ãƒãƒƒãƒã•ã›ãã®çµæœã¯ç ´æ£„ã™ã‚‹
        .then_ignore(
            // åå‰ã®é€šã‚Š`just`ã¯å¼•æ•°ã®æ–‡å­—åˆ—ã«ãã®ã¾ã¾ãƒãƒƒãƒã™ã‚‹
            just('/').labelled("between yyyy and mm"))
        // mm
        // thenã§ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ã¤ãªã’ã‚‹ã¨åŒæ–¹ã®çµæœãŒã‚¿ãƒ—ãƒ«ã§å¾—ã‚‰ã‚Œã‚‹
        .then(number(2).labelled("mm"))
        .then_ignore(just('/').labelled("betweel mm and dd"))
        // dd
        .then(number(2).labelled("dd"))
        .map(|((y, m), d)| (y, m, d))
}

#[test]
fn test_yyyy_mm_dd() {
    assert_eq!(yyyy_mm_dd().parse("2020/03/19").unwrap(), (2020, 03, 19));
    assert!(yyyy_mm_dd().parse("20201/03/19").is_err());

    // ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚ãã®ã¾ã¾ãƒ‘ãƒ¼ã‚¹ã‚’ç¶šã‘ã‚‹
    assert_eq!(
        yyyy_mm_dd().parse_recovery("20201/03/19").0,
        Some((20201, 03, 19))
    );
}
```

ã‚¨ãƒ©ãƒ¼ã®å‹ã«[`chumsky::error::Simple`](https://docs.rs/chumsky/0.8.0/chumsky/error/struct.Simple.html)ã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚
ã“ã®è¨˜äº‹ã§ã¯è¡Œã„ã¾ã›ã‚“ãŒç‹¬è‡ªã®ã‚¨ãƒ©ãƒ¼ã‚’è¨˜éŒ²ã™ã‚‹ãŸã‚ã«ã‚¨ãƒ©ãƒ¼å‹ã‚’è‡ªåˆ†ã§ã¤ãã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
Chumskyã«ãƒ“ãƒ«ãƒˆã‚¤ãƒ³ã§å…¥ã£ã¦ã„ã‚‹`chumsky::error::Simple`ã‚‚ã„ãã¤ã‹ã®ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã‚’è¨˜éŒ²ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```rust
pub enum SimpleReason<I, S> {
    // äºˆæœŸã—ãªã„å…¥åŠ›ãŒæ¥ãŸ
    Unexpected,
    // ã‹ã£ã“ã®å¯¾å¿œãŒå–ã‚Œã¦ã„ãªã„
    Unclosed {
        span: S,
        delimiter: I,
    },
    // ã‚«ã‚¹ã‚¿ãƒ ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    Custom(String),
}
```

# Ariadneå…¥é–€

Ariadneã¯ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚Chumskyã¨åŒã˜æ–¹ãŒä½œè€…ã§ã™ã€‚

![ariadne](/images/ariadne.png)

ã“ã‚“ãªæ„Ÿã˜ã§ã‹ã£ã“ã‚ˆãã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã‚’ã™ã‚‹ä¾‹

```rust
use ariadne::{Color, Fmt, Label, Report, ReportKind, Source};

fn main() {
    let src_id = "input.txt";
    let src = "2022a/03/19";

    Report::build(ReportKind::Error, src_id, 4)
        .with_message("Unexpected char")
        .with_label(
            Label::new((src_id, /* ã‚¹ãƒ‘ãƒ³ã¯æ–‡å­—æ•°å˜ä½ã€ãƒã‚¤ãƒˆæ•°ã§ã¯ãªã„ */ 4..5))
                .with_message(format!("unexpected char {}", "a".fg(Color::Red))),
        )
        .finish()
        .print((src_id, Source::from(src)))
        .unwrap();
}
```

Chumsky, Ariadneä¸¡æ–¹ã¨ã‚‚æ–‡å­—åˆ—ã®`Span`ã¯æ–‡å­—æ•°å˜ä½ã®`std::ops::Range<usize>`ãªã®ã§ä»–ã®ãƒ‘ãƒ¼ã‚µãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§Ariadneã‚’ä½¿ã†éš›ã«ã¯æ³¨æ„ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

å¤§ä½“è¦‹ãŸã ã‘ã§ã‚ã‹ã‚‹ã¨æ€ã†ã®ã§ã€Ariadneã§ä¸Šã§ã¤ãã£ãŸãƒ‘ãƒ¼ã‚µãƒ¼ã®ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã‚’ã‚„ã£ã¦ã„ãã¾ã™ã€‚
[`chumsky::error::Simple`](https://docs.rs/chumsky/0.8.0/chumsky/error/struct.Simple.html)ã‚’ã¿ã¦ã„ã„æ„Ÿã˜ã«ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã®`Report`ã‚’ä½œã£ã¦ã„ãã ã‘ã§ã™ã€‚

```rust
fn main() {
    for src in ["20221/03/19", "2021/june/10", "2022@10@10", "2022/"] {
        let (_, errs) = yyyy_mm_dd().parse_recovery(src);

        for e in errs {
            let message = match e.reason() {
                chumsky::error::SimpleReason::Unexpected
                | /* æ‹¬å¼§ã®å¯¾å¿œã«ã¤ã„ã¦ã¯ã“ã®ãƒ‘ãƒ¼ã‚µãƒ¼ã«ã¤ã„ã¦ã¯é–¢ä¿‚ãŒãªã„ã®ã§ã“ã®ãƒãƒªã‚¢ãƒ³ãƒˆã¯å‡ºã¦ã“ãªã„ */ chumsky::error::SimpleReason::Unclosed { .. } => {
                    format!(
                        "{}{}, expected {}",
                        if e.found().is_some() {
                            "unexpected token"
                        } else {
                            "unexpected end of input"
                        },
                        if let Some(label) = e.label() {
                            format!(" while parsing {}", label.fg(Color::Green))
                        } else {
                            " something else".to_string()
                        },
                        if e.expected().count() == 0 {
                            "somemething else".to_string()
                        } else {
                            e.expected()
                                .map(|expected| match expected {
                                    Some(expected) => expected.to_string(),
                                    None => "end of input".to_string(),
                                })
                                .collect::<Vec<_>>()
                                .join(", ")
                        }
                    )
                }
                chumsky::error::SimpleReason::Custom(msg) => msg.clone(),
            };

            Report::build(ReportKind::Error, (), e.span().start)
                .with_message(message)
                .with_label(Label::new(e.span()).with_message(match e.reason() {
                    chumsky::error::SimpleReason::Custom(msg) => msg.clone(),
                    _ => format!(
                            "Unexpected {}",
                            e.found()
                                .map(|c| format!("token {}", c.fg(Color::Red)))
                                .unwrap_or_else(|| "end of input".to_string())
                        ),
                }))
                .finish()
                .print(Source::from(src))
                .unwrap();
        }
    }
}
```

![errors](/images/errors.png)

ã„ã„æ„Ÿã˜ã«ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºãŒã§ãã¦ã¾ã™ã€‚

# ãŠã‚ã‚Š

æœ¬è¨˜äº‹ã§ã¯Chumskyã§ãƒ‘ãƒ¼ã‚¹ã—ã€Ariadneã§ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ã‚„ã‚Šã‹ãŸã‚’ç°¡å˜ã«ç´¹ä»‹ã—ã¾ã—ãŸã€‚
èª­è€…ã®æ–¹ãŒä¾‹ãˆã°è‡ªä½œè¨€èªã‚’ä½œã‚‹éš›ã«Chumsky, Ariadneã§ã‚„ã‚‹æ–¹æ³•ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚