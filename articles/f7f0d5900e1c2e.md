---
title: "mitmproxyã¿ãŸã„ãªã‚„ã¤ã‚’Rustã§ä½œã£ãŸã®ã§å­¦ã‚“ã ã“ã¨æ›¸ã"
emoji: "ðŸ¦€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["rust", "http", "hyper"]
published: false
---

# ã¯ã˜ã‚ã«

Rustã§[mitmproxy](https://mitmproxy.org/)ã¿ãŸã„ãªã‚„ã¤ã‚’ä½œã‚Œã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å…¬é–‹ã—ãŸã®ã§ãã®ã¨ãã«å­¦ã‚“ã ã“ã¨ã‚’æ›¸ãã¾ã™ã€‚ãƒªãƒã‚¸ãƒˆãƒªã¯ã“ã¡ã‚‰ã€‚
https://github.com/hatoo/http-mitm-proxy

## mitmproxyã¨ã¯

[mitmproxy](https://mitmproxy.org/)ã¯ã€HTTPã®ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã§ã€HTTPSã®é€šä¿¡ã®å†…å®¹ã‚‚è¦‹ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ãŒç‰¹å¾´ã§ã™ã€‚

## HTTPãƒ—ãƒ­ã‚­ã‚·

HTTPãƒ—ãƒ­ã‚­ã‚·ã¯HTTPã®ãƒ¬ãƒ™ãƒ«ã§å‹•ä½œã™ã‚‹ãƒ—ãƒ­ã‚­ã‚·ã§ã™ã€‚ãªã®ã§ãƒ—ãƒ­ã‚­ã‚·å´ã‚‚HTTPã‚’ç†è§£ã£ã¦ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

### HTTPã®é€šä¿¡(ãƒ—ãƒ­ã‚­ã‚·ãªã—)

```bash
printf "GET / HTTP/1.1\r\nHost: example.com\r\nConnection: close\r\n\r\n" | nc example.com 80
HTTP/1.1 200 OK
Accept-Ranges: bytes
Age: 360610
Cache-Control: max-age=604800
Content-Type: text/html; charset=UTF-8
Date: Mon, 18 Nov 2024 06:44:56 GMT
Etag: "3147526947+gzip"
Expires: Mon, 25 Nov 2024 06:44:56 GMT
Last-Modified: Thu, 17 Oct 2019 07:18:26 GMT
Server: ECAcc (sac/256D)
Vary: Accept-Encoding
X-Cache: HIT
Content-Length: 1256
Connection: close

... # ä»¥ä¸‹Body (çœç•¥)
```

### HTTPã®é€šä¿¡(ãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ã†)

```bash
printf "GET http://example.com/ HTTP/1.1\r\nHost: example.com\r\nConnection: close\r\n\r\n" | nc localhost 3003 # http://localhost:3003 HTTPã«ãƒ—ãƒ­ã‚­ã‚·ã‚’ç«‹ã¦ã¦ã„ã‚‹
HTTP/1.1 200 OK
... # åŒã˜ãªã®ã§ä»¥ä¸‹çœç•¥
```

ã“ã®ã‚ˆã†ã«ã„ã¤ã‚‚ãªã‚‰`GET / HTTP/1.1`ã¨é€ã‚‹ã¨ã“ã‚ã‚’`GET http://example.com/ HTTP/1.1`ã¨é€ã‚‹ã“ã¨ã§ãƒ—ãƒ­ã‚­ã‚·ã«ã©ã“ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„ã‹ã‚’ä¼ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### HTTPSã®é€šä¿¡(ãƒ—ãƒ­ã‚­ã‚·ãªã—)

```bash
printf "GET / HTTP/1.1\r\nHost: example.com\r\nConnection: close\r\n\r\n" | ncat --ssl example.com 443
... # åŒã˜ãªã®ã§ä»¥ä¸‹çœç•¥
```

### HTTPSã®é€šä¿¡(ãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ã†)

ã“ã‚Œã¯ç‰¹æ®Šãªã®ã§curlã§ã‚„ã£ã¦ã¿ã¾ã™ã€‚

```bash
curl -v https://example.com -x http://localhost:3003
*   Trying 127.0.0.1:3003...
* Connected to (nil) (127.0.0.1) port 3003 (#0)
* allocate connect buffer!
* Establish HTTP proxy tunnel to example.com:443
> CONNECT example.com:443 HTTP/1.1
> Host: example.com:443
> User-Agent: curl/7.81.0
> Proxy-Connection: Keep-Alive
>
< HTTP/1.1 200 OK
< Date: Mon, 18 Nov 2024 10:17:21 GMT
<
* Proxy replied 200 to CONNECT request
* CONNECT phase completed!
* ALPN, offering h2
* ALPN, offering http/1.1
*  CAfile: /etc/ssl/certs/ca-certificates.crt
*  CApath: /etc/ssl/certs
* TLSv1.0 (OUT), TLS header, Certificate Status (22):
* TLSv1.3 (OUT), TLS handshake, Client hello (1):
* TLSv1.2 (IN), TLS header, Certificate Status (22):
* TLSv1.3 (IN), TLS handshake, Server hello (2):
* TLSv1.2 (OUT), TLS header, Finished (20):
* TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):
* TLSv1.2 (OUT), TLS header, Certificate Status (22):
* TLSv1.3 (OUT), TLS handshake, Client hello (1):
* TLSv1.2 (IN), TLS header, Finished (20):
* TLSv1.2 (IN), TLS header, Certificate Status (22):
* TLSv1.3 (IN), TLS handshake, Server hello (2):
* TLSv1.2 (IN), TLS header, Supplemental data (23):
* TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):
* TLSv1.2 (IN), TLS header, Supplemental data (23):
* TLSv1.3 (IN), TLS handshake, Certificate (11):
* TLSv1.2 (IN), TLS header, Supplemental data (23):
* TLSv1.3 (IN), TLS handshake, CERT verify (15):
* TLSv1.2 (IN), TLS header, Supplemental data (23):
* TLSv1.3 (IN), TLS handshake, Finished (20):
* TLSv1.2 (OUT), TLS header, Supplemental data (23):
* TLSv1.3 (OUT), TLS handshake, Finished (20):
* SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384
* ALPN, server accepted to use h2
* Server certificate:
*  subject: C=US; ST=California; L=Los Angeles; O=Internetï¿½Corporationï¿½forï¿½Assignedï¿½Namesï¿½andï¿½Numbers; CN=www.example.org
*  start date: Jan 30 00:00:00 2024 GMT
*  expire date: Mar  1 23:59:59 2025 GMT
*  subjectAltName: host "example.com" matched cert's "example.com"
*  issuer: C=US; O=DigiCert Inc; CN=DigiCert Global G2 TLS RSA SHA256 2020 CA1
*  SSL certificate verify ok.
* Using HTTP2, server supports multiplexing
* Connection state changed (HTTP/2 confirmed)
* Copying HTTP/2 data in stream buffer to connection buffer after upgrade: len=0
* TLSv1.2 (OUT), TLS header, Supplemental data (23):
* TLSv1.2 (OUT), TLS header, Supplemental data (23):
* TLSv1.2 (OUT), TLS header, Supplemental data (23):
* Using Stream ID: 1 (easy handle 0x559036dbdeb0)
* TLSv1.2 (OUT), TLS header, Supplemental data (23):
> GET / HTTP/2
> Host: example.com
> user-agent: curl/7.81.0
> accept: */*
>
* TLSv1.2 (IN), TLS header, Supplemental data (23):
* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
* TLSv1.2 (IN), TLS header, Supplemental data (23):
* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
* old SSL session ID is stale, removing
* TLSv1.2 (IN), TLS header, Supplemental data (23):
* TLSv1.2 (OUT), TLS header, Supplemental data (23):
* TLSv1.2 (IN), TLS header, Supplemental data (23):
* TLSv1.2 (IN), TLS header, Supplemental data (23):
* TLSv1.2 (IN), TLS header, Supplemental data (23):
< HTTP/2 200
< age: 533083
< cache-control: max-age=604800
< content-type: text/html; charset=UTF-8
< date: Mon, 18 Nov 2024 10:17:23 GMT
< etag: "3147526947+gzip+ident"
< expires: Mon, 25 Nov 2024 10:17:23 GMT
< last-modified: Thu, 17 Oct 2019 07:18:26 GMT
< server: ECAcc (sac/251E)
< vary: Accept-Encoding
< x-cache: HIT
< content-length: 1256
<
* TLSv1.2 (IN), TLS header, Supplemental data (23):
* TLSv1.2 (IN), TLS header, Supplemental data (23):
... # ä»¥ä¸‹Bodyçœç•¥
* Connection #0 to host (nil) left intact
```

æœ€åˆã«ãƒ—ãƒ­ã‚­ã‚·ã«`CONNECT example.com:443 HTTP/1.1`ã¨é€ã‚‹ã“ã¨ã§ãƒ—ãƒ­ã‚­ã‚·ã«å¯¾ã—ã¦HTTPSã®é€šä¿¡ã‚’ã™ã‚‹ã“ã¨ã‚’ä¼ãˆã¾ã™ã€‚
ãã®å¾Œã¯example.com:443ã¨TCPã®ãƒ¬ãƒ™ãƒ«ã§ãƒˆãƒ³ãƒãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã®ã§ãã“ã‹ã‚‰æ™®é€šã«HTTPSã®é€šä¿¡ã‚’è¡Œã„ã¾ã™ã€‚(ã“ã®ä¾‹ã§ã¯exmaple.comã¨HTTP/2ã§é€šä¿¡ã—ã¦ã„ã¾ã™)

## mitmproxyã®ä»•çµ„ã¿

